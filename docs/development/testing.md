# Testing Strategy

This document specifies the non-negotiable testing principles that govern **core code**, *plugins*, *blueprints*, and *integrations*.

## 1  Core (`src/`)
* Unit tests for every public function/class (fast, pure Python).
* Static analysis – Ruff, MyPy, Bandit – must pass on every PR.
* Contract test: `tests/contracts/test_plugins.py` dynamically imports **all** registered plugins to ensure they satisfy the abstract-method contract.

## 2  Plugins (`src/plugins/…`)
* Each plugin ships a smoke test (auto-generated by `mlops_cli plugin add`).
* Test must instantiate, initialise, and call `execute()` returning a `ComponentResult`.
* Heavy external deps may set `TEST_MODE` env-var to no-op – but test must still succeed.

## 3  Blueprints (`blueprints/`)
* **Unit** tests for helper functions.
* **Pipeline smoke** test that runs `pipeline.py` with local resources.
* Optional regression fixtures (hash of output dataset) for stability.

CI matrix runs every blueprint nightly; PRs touching a blueprint run only its smoke test.

## 4  Integrations / Stacks (`integrations/`)
* IaC **plan/render** must be lint-clean (`terraform validate`, `helm template --dry-run`).
* **Smoke deploy** in Docker/kind; health probe endpoints must return 2xx.
* Destroy must succeed – leaks fail the job.

## 5  CLI
* Sub-commands tested with Typer's `CliRunner`.
* Mutating commands (`plugin add`) run in a temp directory; resulting files must pass Ruff.

## 6  OpenLineage
* Heartbeat test to local Marquez.
* JSON schema validation of emitted events.

## 7  Performance budgets
* Each blueprint / integration may include `budget.yaml` (max RAM, CPU seconds). CI fails if exceeded by >20 %.

## 8  Security
* Trivy scan (`HIGH`,`CRITICAL`) must be 0 (both filesystem and container scans).
* Bandit static analysis and Safety dependency check pass with no **HIGH** or **CRITICAL** findings.

## 9  Documentation
* `mkdocs build --strict` must succeed (code blocks are doctested).
* Broken links are forbidden – run `make link-check` before pushing.

---
Contributions that add new artefacts **must** include corresponding tests and, when relevant, update CI matrices. Use `make all-checks` locally before opening a PR.
